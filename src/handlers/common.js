const { Markup } = require('telegraf');
const db = require('../database/connection');
const User = require('../models/User');

module.exports = function setupCommonHandlers(bot) {
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
  bot.command('help', async (ctx) => {
    const user = await User.findByTelegramId(ctx.from.id);
    
    let message = 'üìã *–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*\n\n';
    
    if (!user || !user.is_active) {
      message += 'üë§ *–î–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:*\n';
      message += '/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n';
      message += '/zapros - –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º\n';
      message += '/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n';
      message += '–ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤–∞–º –æ—Ç–∫—Ä–æ—é—Ç—Å—è –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏.';
    } else {
      message += '‚úÖ *–í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!*\n\n';
      
      message += 'üì¶ *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—ã–ª–∫–∞–º–∏:*\n';
      message += '‚Ä¢ "–ú–æ–∏ –ø–æ—Å—ã–ª–∫–∏" - –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–æ—Å—ã–ª–æ–∫\n';
      message += '‚Ä¢ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—ã–ª–∫—É" - –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –ø–æ—Å—ã–ª–∫—É\n';
      message += '‚Ä¢ –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å—ã –∏ —É–¥–∞–ª—è—Ç—å –ø–æ—Å—ã–ª–∫–∏\n\n';
      
      message += 'üè™ *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º:*\n';
      message += '‚Ä¢ "–°–∫–ª–∞–¥" - –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤\n';
      message += '‚Ä¢ "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä" - –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä\n';
      message += '‚Ä¢ "–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞" - –ø–æ–∏—Å–∫ –ø–æ SKU –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é\n';
      message += '‚Ä¢ "–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" - –æ–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏\n\n';
      
      message += 'üîî *–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:*\n';
      message += '‚Ä¢ "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è" - –ø—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π\n';
      message += '‚Ä¢ –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ—Å—ã–ª–∫–∏ –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n\n';
      
      message += 'üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*\n';
      message += '‚Ä¢ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" - –≤–∞—à–∞ –ª–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n';
      
      message += 'üÜò *–ü–æ–¥–¥–µ—Ä–∂–∫–∞:*\n';
      message += '‚Ä¢ "–ü–æ–º–æ—â—å" - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n';
      message += '‚Ä¢ /support - —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º\n';
      
      if (user.is_admin || ctx.from.id === parseInt(process.env.ADMIN_ID)) {
        message += '\nüëë *–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:*\n';
        message += '/requests - –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ—Å—Ç—É–ø–∞\n';
        message += '/users - —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n';
        message += '/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã\n';
        message += '/broadcast - —Ä–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π\n';
      }
    }
    
    await ctx.reply(message, { parse_mode: 'Markdown' });
  });

  // –ö–æ–º–∞–Ω–¥–∞ /support
  bot.command('support', async (ctx) => {
    const user = await User.findByTelegramId(ctx.from.id);
    
    const supportMessage = 
      'üÜò *–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞*\n\n' +
      '–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:\n\n' +
      '1. *–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à –¥–æ—Å—Ç—É–ø* - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start\n' +
      '2. *–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é* - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /help\n' +
      '3. *–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å* - –æ–ø–∏—à–∏—Ç–µ –µ–µ –∑–¥–µ—Å—å\n\n' +
      '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.';
    
    await ctx.reply(supportMessage, { parse_mode: 'Markdown' });
    
    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    const adminId = process.env.ADMIN_ID;
    if (adminId) {
      try {
        const adminMessage = 
          `üÜò –ó–∞–ø—Ä–æ—Å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n` +
          `üë§ ${user?.first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'} ${user?.last_name || ''}\n` +
          `üìõ @${user?.username || '–Ω–µ—Ç username'}\n` +
          `üÜî ${ctx.from.id}\n` +
          `üìÖ ${new Date().toLocaleString('ru-RU')}`;
        
        await ctx.telegram.sendMessage(adminId, adminMessage);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω—É:', error);
      }
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ /about
  bot.command('about', (ctx) => {
    ctx.reply(
      'ü§ñ *Parcel Manager Bot*\n\n' +
      '–ë–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏:\n' +
      '‚Ä¢ üì¶ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å—ã–ª–æ–∫ –∏–∑ –ö–∏—Ç–∞—è\n' +
      '‚Ä¢ üè™ –£—á–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ\n' +
      '‚Ä¢ üîî –°–∏—Å—Ç–µ–º–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π\n' +
      '‚Ä¢ üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞–º–∏\n\n' +
      'üìÖ –í–µ—Ä—Å–∏—è: 1.0.0\n' +
      'üöÄ –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å–∞',
      { parse_mode: 'Markdown' }
    );
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
  bot.on('text', async (ctx) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ª–∏ —Ç–µ–∫—Å—Ç –¥—Ä—É–≥–∏–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
    if (ctx.message.text.startsWith('/')) {
      const command = ctx.message.text.split(' ')[0];
      
      // –°–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
      const knownCommands = [
        '/start', '/zapros', '/help', '/support', '/about',
        '/requests', '/users', '/stats', '/broadcast'
      ];
      
      if (!knownCommands.includes(command)) {
        await ctx.reply(
          '‚ùì *–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞*\n\n' +
          `–ö–æ–º–∞–Ω–¥–∞ "${command}" –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞.\n` +
          '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.',
          { parse_mode: 'Markdown' }
        );
      }
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ callback_query
  bot.on('callback_query', async (ctx) => {
    // –û—Ç–≤–µ—Ç –Ω–∞ –≤—Å–µ callback_query —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏"
    try {
      await ctx.answerCbQuery();
    } catch (error) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª–∏
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
  bot.use(async (ctx, next) => {
    try {
      await next();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ:', error);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      let errorMessage = '‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.\n';
      errorMessage += '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.';
      
      try {
        await ctx.reply(errorMessage);
      } catch (replyError) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:', replyError);
      }
      
      // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
      const userInfo = ctx.from ? 
        `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${ctx.from.id} (@${ctx.from.username || '–Ω–µ—Ç'})` : 
        '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
      
      console.error(`–û—à–∏–±–∫–∞ –¥–ª—è ${userInfo}:`, error.message);
    }
  });
};